BATCH=1
PARA.ITER <- expand.grid( type=c(1,2), # 1=linear, 2=cubic
s=c(100,200,500,1000),
cut1=20,
cut2=40,
iter=c(1:10000))
source("Simulation_Functions.R")
PLOT <- FALSE
Var.Y <- 10
Boot.Num <- 1000 # number of bootstrap samples
GAMMA <- 1
KNOT <- c(10,10,10)
absbias.com <- function(x, tau.m)  apply(x, 2, function(x) abs(mean(x - tau.m)))
sd.com <- function(x)  apply(x, 2, function(x) sd(x))
RMSE.com <- function(x, tau.m)  apply(x, 2, function(x) sqrt(mean((x - tau.m)^2)))
outcome.type <- PARA.ITER[BATCH,1] # outcome model
s <- PARA.ITER[BATCH,2] # sample size
cut1 <- PARA.ITER[BATCH,3]  # regular testing time
cut2 <- PARA.ITER[BATCH,4] # max testing time
iter <- PARA.ITER[BATCH,5]
File.NDE <- sprintf("Summary_NDE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.NIE <- sprintf("Summary_NIE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.TE <- sprintf("Summary_TE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.Cover <- sprintf("Summary_Cover_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.HP <- sprintf("Summary_HP_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
# DGP ---
k0 <- 5
Yk0.threshold <- Y.Z1.B.Ft.Lin(k0,0,1,cut1)
dat <- data_generation(N=s,
k0=k0,
Yk0.threshold = Yk0.threshold,
CUT=cut1,
CUT2=cut2,
Var.Y=Var.Y,
type="Lin")
Data.All <- dat$Data.All
Data.Obs <- dat$Data.Obs
covariate_names <- c("X1", "X2")
# True Effects and Oracle Estimates
Oracle <- aggregate(cbind(Y.Z1.T1,Y.Z1.T1.Obs,
Y.Z1.TZ,Y.Z1.TZ.Obs,
Y.Z1.T0,Y.Z1.T0.Obs,
Y.Z0.T0,Y.Z0.T0.Obs)~K,Data.All,"mean")
True <- aggregate(cbind(Y.Z1.T1.True,
Y.Z1.TZ.True,
Y.Z1.T0.True,
Y.Z0.T0.True)~K,dat$Data.All,"mean")
NDE.Oracle <- Oracle$Y.Z1.T0.Obs - Oracle$Y.Z0.T0.Obs
NIE.Oracle <- Oracle$Y.Z1.TZ.Obs - Oracle$Y.Z1.T0.Obs
TE.Oracle  <- Oracle$Y.Z1.TZ.Obs - Oracle$Y.Z0.T0.Obs
NDE.True <- True$Y.Z1.T0.True - True$Y.Z0.T0.True
NIE.True <- True$Y.Z1.TZ.True - True$Y.Z1.T0.True
TE.True  <- True$Y.Z1.TZ.True - True$Y.Z0.T0.True
Y.Z0.T0.True <- True$Y.Z0.T0.True
Y.Z1.T0.True <- True$Y.Z1.T0.True
Y.Z1.TZ.True <- True$Y.Z1.TZ.True
Y.Z1.T1.True <- True$Y.Z1.T1.True
Data=Data.Obs
covariate = covariate_names
k0=k0
Yk0="Yk0"
CUT=cut1
CUT2=cut2
x0=NULL
type="GAM"
knot=KNOT
gamma=GAMMA
CN <- colnames(Data)
CN.X <- CN[substr(CN,1,1)=="X"]
CN.Yk0X <- c(Yk0,CN[substr(CN,1,1)=="X"])
Data <- Data[order(Data[,CN.X[1]],Data[,CN.X[2]]),]
Data <- Data[Data$K>k0,]                            # Throw away the beginning of the time series
Data.Long <- Data
Data.Short <- unique(Data[,c("ID","Z","T",CN.Yk0X)])
Data.Yk0X.Unique <- as.data.frame(unique(Data.Short[,CN.Yk0X]))
colnames(Data.Yk0X.Unique) <- CN.Yk0X
Data.Yk0X.Unique$weight <- sapply(1:nrow(Data.Yk0X.Unique),function(ii){
match <- Reduce('&',lapply(covariate, function(col){
Data.Short[[col]]== Data.Yk0X.Unique[[col]][ii]
}))
mean(match)
})
Data.X.Unique <- as.data.frame(unique(Data.Short[,CN.X]))
colnames(Data.X.Unique) <- CN.X
Data.X.Unique$weight <- sapply(1:nrow(Data.X.Unique),function(ii){
match <- Reduce('&',lapply(covariate, function(col){
Data.Short[[col]]== Data.X.Unique[[col]][ii]
}))
mean(match)
})
Z0T0 <- which(Data.Long$Z==0 & Data.Long$T==0)
Data.Long.Z0T0 <- Data.Long[Z0T0,]
Z1T0 <- which(Data.Long$Z==1 & Data.Long$T==0)
Data.Long.Z1T0 <- Data.Long[Z1T0,]
Z1T1 <- which(Data.Long$Z==1 & Data.Long$T==1)
Data.Long.Z1T1 <- Data.Long[Z1T1,]
SELECT <- FALSE
model.cut1 <- knot[1]
model.cut2 <- knot[2]
model.cut3 <- knot[3]
covariates <- paste(covariate, collapse = "+")
covariates_Yk0 <- paste(c(covariate,Yk0), collapse = "+")
covariates_complex <- paste(covariate, collapse = "*")
gam_intercept_model41 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut1),sep = "")),collapse = "+")
gam_intercept_model42 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut2),sep = "")),collapse = "+")
gam_intercept_model43 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut3),sep = "")),collapse = "+")
gam_model_1 <- as.formula(paste(sprintf("Y~s(K,k=%s)+",model.cut1),
covariates_Yk0,"+",
gam_intercept_model41))
gam_model_1
Z0T0 <- which(Data.Long$Z==0 & Data.Long$T==0)
Data.Long.Z0T0 <- Data.Long[Z0T0,]
Z1T0 <- which(Data.Long$Z==1 & Data.Long$T==0)
Data.Long.Z1T0 <- Data.Long[Z1T0,]
Z1T1 <- which(Data.Long$Z==1 & Data.Long$T==1)
Data.Long.Z1T1 <- Data.Long[Z1T1,]
SELECT <- FALSE
model.cut1 <- knot[1]
model.cut2 <- knot[2]
model.cut3 <- knot[3]
covariates <- paste(covariate, collapse = "+")
covariates_Yk0 <- paste(c(covariate,Yk0), collapse = "+")
covariates_complex <- paste(covariate, collapse = "*")
gam_intercept_model41 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut1),sep = "")),collapse = "+")
gam_intercept_model42 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut2),sep = "")),collapse = "+")
gam_intercept_model43 <- paste(sapply(c(covariate,Yk0), function(x) paste(sprintf("s(K,by=%s,k=%s)",x,model.cut3),sep = "")),collapse = "+")
gam_model_1 <- as.formula(paste(sprintf("Y~s(K,k=%s)+",model.cut1),
covariates_Yk0,"+",
gam_intercept_model41))
gam_model_2 <- as.formula(paste(sprintf("Y~s(K,k=%s)+",model.cut2),
covariates_Yk0,"+",
gam_intercept_model42))
gam_model_3 <- as.formula(paste(sprintf("Y~s(K,k=%s)+",model.cut3),
covariates_Yk0,"+",
gam_intercept_model43))
gam_model_short_1 <- as.formula(paste(sprintf("Y~1+s(K,k=%s)+",model.cut1), covariates_Yk0))
gam_model_short_2 <- as.formula(paste(sprintf("Y~1+s(K,k=%s)+",model.cut2), covariates_Yk0))
gam_model_short_3 <- as.formula(paste(sprintf("Y~1+s(K,k=%s)+",model.cut3), covariates_Yk0))
gam_model_T <- as.formula(paste("T~",covariates_complex))
gam_model_Yk0 <- as.formula(paste("Yk0~",covariates_complex))
GAM.Y.Z0.T0 <- try(gam(gam_model_1, data=Data.Long.Z0T0,select=SELECT,gamma=gamma,method="REML"),silent=TRUE)
GAM.Y.Z1.T0 <- try(gam(gam_model_2, data=Data.Long.Z1T0,select=SELECT,gamma=gamma,method="REML"),silent=TRUE)
GAM.Y.Z1.T1 <- try(gam(gam_model_3, data=Data.Long.Z1T1,select=SELECT,gamma=gamma,method="REML"),silent=TRUE)
gam_model_T
gam_model_Yk0
k0=5
Yk0="Yk0"
CUT=20
CUT2=40
covariate
x0=NULL
BATCH=1
BATCH=1
PARA.ITER <- expand.grid( type=c(1,2), # 1=linear, 2=cubic
s=c(100,200,500,1000),
cut1=20,
cut2=40,
iter=c(1:10000))
source("Simulation_Functions.R")
PLOT <- FALSE
Var.Y <- 10
Boot.Num <- 1000 # number of bootstrap samples
GAMMA <- 1
KNOT <- c(10,10,10)
absbias.com <- function(x, tau.m)  apply(x, 2, function(x) abs(mean(x - tau.m)))
sd.com <- function(x)  apply(x, 2, function(x) sd(x))
RMSE.com <- function(x, tau.m)  apply(x, 2, function(x) sqrt(mean((x - tau.m)^2)))
outcome.type <- PARA.ITER[BATCH,1] # outcome model
s <- PARA.ITER[BATCH,2] # sample size
cut1 <- PARA.ITER[BATCH,3]  # regular testing time
cut2 <- PARA.ITER[BATCH,4] # max testing time
iter <- PARA.ITER[BATCH,5]
File.NDE <- sprintf("Summary_NDE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.NIE <- sprintf("Summary_NIE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.TE <- sprintf("Summary_TE_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.Cover <- sprintf("Summary_Cover_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
File.HP <- sprintf("Summary_HP_Type%0.1d_N_%0.4d_C1_%0.4d_C2_%0.4d_Iter_%0.5d.csv",
outcome.type,s,cut1,cut2,iter)
# DGP ---
k0 <- 5
if(outcome.type==1){
Yk0.threshold <- Y.Z1.B.Ft.Lin(k0,0,1,cut1)
dat <- data_generation(N=s,
k0=k0,
Yk0.threshold = Yk0.threshold,
CUT=cut1,
CUT2=cut2,
Var.Y=Var.Y,
type="Lin")
} else {
Yk0.threshold <- Y.Z1.B.Ft.Cub(k0,0,1,cut1)
dat <- data_generation(N=s,
k0=k0,
Yk0.threshold = Yk0.threshold,
CUT=cut1,
CUT2=cut2,
Var.Y=Var.Y,
type="Cub")
}
Data.All <- dat$Data.All
Data.Obs <- dat$Data.Obs
covariate_names <- c("X1", "X2")
# True Effects and Oracle Estimates
Oracle <- aggregate(cbind(Y.Z1.T1,Y.Z1.T1.Obs,
Y.Z1.TZ,Y.Z1.TZ.Obs,
Y.Z1.T0,Y.Z1.T0.Obs,
Y.Z0.T0,Y.Z0.T0.Obs)~K,Data.All,"mean")
True <- aggregate(cbind(Y.Z1.T1.True,
Y.Z1.TZ.True,
Y.Z1.T0.True,
Y.Z0.T0.True)~K,dat$Data.All,"mean")
NDE.Oracle <- Oracle$Y.Z1.T0.Obs - Oracle$Y.Z0.T0.Obs
NIE.Oracle <- Oracle$Y.Z1.TZ.Obs - Oracle$Y.Z1.T0.Obs
TE.Oracle  <- Oracle$Y.Z1.TZ.Obs - Oracle$Y.Z0.T0.Obs
NDE.True <- True$Y.Z1.T0.True - True$Y.Z0.T0.True
NIE.True <- True$Y.Z1.TZ.True - True$Y.Z1.T0.True
TE.True  <- True$Y.Z1.TZ.True - True$Y.Z0.T0.True
Y.Z0.T0.True <- True$Y.Z0.T0.True
Y.Z1.T0.True <- True$Y.Z1.T0.True
Y.Z1.TZ.True <- True$Y.Z1.TZ.True
Y.Z1.T1.True <- True$Y.Z1.T1.True
Data=Data.Obs
covariate = covariate_names
k0=k0
Yk0="Yk0"
CUT=cut1
CUT2=cut2
x0=NULL
type="GAM"
knot=KNOT
gamma=GAMMA
# Data <- data_extend(Data)
CN <- colnames(Data)
CN.X <- CN[substr(CN,1,1)=="X"]
CN.Yk0X <- c(Yk0,CN[substr(CN,1,1)=="X"])
Data <- Data[order(Data[,CN.X[1]],Data[,CN.X[2]]),]
Data <- Data[Data$K>k0,]                            # Throw away the beginning of the time series
Data.Long <- Data
Data.Short <- unique(Data[,c("ID","Z","T",CN.Yk0X)])
Data.Yk0X.Unique <- as.data.frame(unique(Data.Short[,CN.Yk0X]))
colnames(Data.Yk0X.Unique) <- CN.Yk0X
Data.Yk0X.Unique$weight <- sapply(1:nrow(Data.Yk0X.Unique),function(ii){
match <- Reduce('&',lapply(covariate, function(col){
Data.Short[[col]]== Data.Yk0X.Unique[[col]][ii]
}))
mean(match)
})
Data.X.Unique <- as.data.frame(unique(Data.Short[,CN.X]))
colnames(Data.X.Unique) <- CN.X
Data.X.Unique$weight <- sapply(1:nrow(Data.X.Unique),function(ii){
match <- Reduce('&',lapply(covariate, function(col){
Data.Short[[col]]== Data.X.Unique[[col]][ii]
}))
mean(match)
})
model.cut1 <- model.cut2 <- model.cut3 <- NULL
covariates <- paste(covariate, collapse = "+")
covariates_Yk0 <- paste(c(covariate,Yk0), collapse = "+")
covariates_complex <- paste(covariate, collapse = "*")
lm_interaction_model <- as.formula(paste("Y~K+",
covariates_Yk0,"+",
paste(sapply(c(covariate,Yk0), function(x) paste("K:",x,"",sep = "")),
collapse = "+")))
glm_Yk0_model <- as.formula(paste("Yk0~",covariates_complex))
glm_model <- as.formula(paste("T~",covariates_complex))
GAM.Y.Z0.T0 <- lm(lm_interaction_model, data=Data.Long[Data.Long$Z==0 & Data.Long$T==0,])
GAM.Y.Z1.T0 <- lm(lm_interaction_model, data=Data.Long[Data.Long$Z==1 & Data.Long$T==0,])
GAM.Y.Z1.T1 <- lm(lm_interaction_model, data=Data.Long[Data.Long$Z==1 & Data.Long$T==1,])
glm_Yk0_model
lm_interaction_model
lm_interaction_model
model.cut1 <- model.cut2 <- model.cut3 <- NULL
covariates <- paste(covariate, collapse = "+")
covariates_Yk0 <- paste(c(covariate,Yk0), collapse = "+")
covariates_complex <- paste(covariate, collapse = "*")
lm_interaction_model <- as.formula(paste("Y~K+I(K^2)+I(K^3)+", covariates_Yk0,"+",
paste(sapply(c(covariate,Yk0), function(x) paste("K:",x,"",sep = "")),
collapse = "+")))
glm_Yk0_model <- as.formula(paste("Yk0~",covariates_complex))
glm_model <- as.formula(paste("T~",covariates_complex))
lm_interaction_model
